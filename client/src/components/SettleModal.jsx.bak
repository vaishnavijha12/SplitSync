import React, { useState, useEffect } from 'react';
import api from '../api/client';
import toast from 'react-hot-toast';
import { useAuth } from '../context/AuthContext';
import {
    X, Wallet, Smartphone, ArrowRight, Copy, CheckCircle2,
    AlertCircle, ExternalLink, QrCode, Loader2, Clock, Check, XCircle
} from 'lucide-react';

// â”€â”€â”€ QR Code generator using a free API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const UPIQRCode = ({ value, size = 200 }) => {
    const encoded = encodeURIComponent(value);
    return (
        <img
            src={`https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&data=${encoded}&bgcolor=ffffff&color=1e293b&margin=10`}
            alt="UPI QR Code"
            className="rounded-2xl shadow-lg border border-slate-100"
            width={size}
            height={size}
        />
    );
};

// â”€â”€â”€ Payment App Button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const AppButton = ({ name, emoji, color, upiLink }) => (
    <a
        href={upiLink}
        target="_blank"
        rel="noopener noreferrer"
        className={`flex flex-col items-center gap-2 p-4 rounded-2xl border-2 ${color} hover:scale-105 active:scale-95 transition-all cursor-pointer`}
    >
        <span className="text-3xl">{emoji}</span>
        <span className="text-xs font-bold text-slate-700">{name}</span>
    </a>
);

// â”€â”€â”€ Main Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
export default function SettleModal({ settlement, groupId, onClose, onSettled }) {
    const { user } = useAuth();
    const [method, setMethod] = useState(null); // null | 'wallet' | 'upi'
    const [walletStep, setWalletStep] = useState('confirm'); // confirm | processing | success | failed
    const [upiStep, setUpiStep] = useState('generate'); // generate | show | confirmed | success
    const [upiData, setUpiData] = useState(null);
    const [copied, setCopied] = useState(false);
    const [confirming, setConfirming] = useState(false);

    const amountStr = (settlement.amount / 100).toFixed(2);
    const walletBalance = (user?.wallet_balance || 0) / 100;
    const isInsufficient = (user?.wallet_balance || 0) < settlement.amount;

    // â”€â”€ Wallet payment â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const handleWalletSettle = async () => {
        setWalletStep('processing');
        await new Promise(r => setTimeout(r, 1500));
        try {
            await api.post('/payments/settle', {
                to_user_id: settlement.to.id,
                amount: settlement.amount / 100,
                group_id: groupId,
                note: 'Settled via SplitSync Wallet',
            });
            setWalletStep('success');
            setTimeout(onSettled, 2000);
        } catch (err) {
            setWalletStep('failed');
            toast.error(err.response?.data?.error || 'Payment failed');
        }
    };

    // â”€â”€ UPI: generate link â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const handleGenerateUPI = async () => {
        setUpiStep('loading');
        try {
            const res = await api.post('/payments/upi/create', {
                to_user_id: settlement.to.id,
                amount: settlement.amount / 100,
                group_id: groupId,
                note: `SplitSync: group settlement`,
            });
            setUpiData(res.data);
            setUpiStep('show');
        } catch (err) {
            toast.error('Failed to generate UPI link');
            setUpiStep('generate');
        }
    };

    // â”€â”€ UPI: copy link â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const handleCopy = () => {
        navigator.clipboard.writeText(upiData.upi_link);
        setCopied(true);
        toast.success('UPI link copied!');
        setTimeout(() => setCopied(false), 2500);
    };

    // â”€â”€ UPI: confirm sent â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const handleUPIConfirm = async () => {
        setConfirming(true);
        try {
            await api.post(`/payments/upi/confirm/${upiData.transaction.id}`);
            setUpiStep('confirmed');
        } catch (err) {
            toast.error(err.response?.data?.error || 'Failed to confirm');
        } finally {
            setConfirming(false);
        }
    };

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    return (
        <div className="fixed inset-0 bg-slate-900/70 backdrop-blur-md flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-3xl w-full max-w-sm shadow-2xl overflow-hidden animate-scale-in">

                {/* â”€â”€ Method Selection â”€â”€ */}
                {method === null && (
                    <div className="p-8">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-xl font-bold text-slate-900">Settle Up</h3>
                            <button onClick={onClose} className="p-2 rounded-full text-slate-400 hover:bg-slate-100 transition-colors"><X size={18} /></button>
                        </div>

                        {/* Amount summary */}
                        <div className="text-center py-6 mb-6 bg-slate-50 rounded-2xl">
                            <p className="text-sm text-slate-400 font-medium mb-1">You pay</p>
                            <p className="text-4xl font-black text-slate-900 tracking-tight">â‚¹{amountStr}</p>
                            <p className="text-sm text-slate-500 mt-2">to <span className="font-bold text-slate-700">{settlement.to.name}</span></p>
                        </div>

                        <p className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-3">Choose payment method</p>
                        <div className="space-y-3">
                            {/* Wallet option */}
                            <button
                                onClick={() => setMethod('wallet')}
                                disabled={isInsufficient}
                                className={`w-full flex items-center gap-4 p-4 rounded-2xl border-2 text-left transition-all
                  ${isInsufficient ? 'opacity-50 cursor-not-allowed border-slate-100 bg-slate-50' : 'border-slate-200 hover:border-primary-400 hover:bg-primary-50 group'}`}
                            >
                                <div className="w-12 h-12 bg-primary-50 text-primary-600 rounded-xl flex items-center justify-center group-hover:bg-primary-100 transition-colors">
                                    <Wallet size={22} />
                                </div>
                                <div className="flex-1">
                                    <p className="font-bold text-slate-900">SplitSync Wallet</p>
                                    <p className="text-xs text-slate-400 mt-0.5">Balance: â‚¹{walletBalance.toFixed(2)}</p>
                                </div>
                                {isInsufficient
                                    ? <span className="text-[10px] font-bold text-rose-400 bg-rose-50 px-2 py-1 rounded-lg">Low</span>
                                    : <ArrowRight size={18} className="text-slate-300 group-hover:text-primary-500 transition-colors" />
                                }
                            </button>

                            {/* UPI option */}
                            <button
                                onClick={() => { setMethod('upi'); handleGenerateUPI(); }}
                                className="w-full flex items-center gap-4 p-4 rounded-2xl border-2 border-slate-200 hover:border-emerald-400 hover:bg-emerald-50 text-left transition-all group"
                            >
                                <div className="w-12 h-12 bg-emerald-50 text-emerald-600 rounded-xl flex items-center justify-center group-hover:bg-emerald-100 transition-colors">
                                    <Smartphone size={22} />
                                </div>
                                <div className="flex-1">
                                    <p className="font-bold text-slate-900">UPI / Payment Apps</p>
                                    <p className="text-xs text-slate-400 mt-0.5">GPay, PhonePe, Paytm & more</p>
                                </div>
                                <ArrowRight size={18} className="text-slate-300 group-hover:text-emerald-500 transition-colors" />
                            </button>
                        </div>
                    </div>
                )}

                {/* â”€â”€ Wallet: Confirm â”€â”€ */}
                {method === 'wallet' && walletStep === 'confirm' && (
                    <div className="p-8">
                        <button onClick={() => setMethod(null)} className="text-xs text-slate-400 mb-4 flex items-center gap-1 hover:text-slate-600"><ArrowRight size={12} className="rotate-180" /> Back</button>
                        <div className="flex items-center gap-3 mb-6">
                            <div className="w-10 h-10 bg-primary-50 text-primary-600 rounded-xl flex items-center justify-center"><Wallet size={20} /></div>
                            <h3 className="text-xl font-bold text-slate-900">Wallet Payment</h3>
                        </div>
                        <div className="bg-slate-50 rounded-2xl p-4 mb-6 space-y-3">
                            <div className="flex justify-between text-sm"><span className="text-slate-500">To</span><span className="font-bold">{settlement.to.name}</span></div>
                            <div className="flex justify-between text-sm"><span className="text-slate-500">Amount</span><span className="font-bold text-rose-500">-â‚¹{amountStr}</span></div>
                            <div className="flex justify-between text-sm border-t border-slate-200 pt-3"><span className="font-semibold text-slate-700">New Balance</span><span className={`font-bold ${isInsufficient ? 'text-rose-500' : 'text-emerald-600'}`}>â‚¹{(walletBalance - parseFloat(amountStr)).toFixed(2)}</span></div>
                        </div>
                        <div className="flex gap-3">
                            <button onClick={onClose} className="flex-1 py-3 border border-slate-200 rounded-xl font-semibold text-slate-600 hover:bg-slate-50 transition-all">Cancel</button>
                            <button onClick={handleWalletSettle} className="flex-[2] py-3 bg-primary-600 text-white rounded-xl font-bold hover:bg-primary-700 shadow-lg active:scale-[0.98] transition-all">Pay â‚¹{amountStr}</button>
                        </div>
                    </div>
                )}

                {method === 'wallet' && walletStep === 'processing' && (
                    <div className="p-16 flex flex-col items-center text-center">
                        <div className="w-16 h-16 border-4 border-primary-600 border-t-transparent rounded-full animate-spin mb-6"></div>
                        <h3 className="text-xl font-bold text-slate-900 mb-2">Processing</h3>
                        <p className="text-sm text-slate-500">Deducting from wallet...</p>
                    </div>
                )}

                {method === 'wallet' && walletStep === 'success' && (
                    <div className="p-16 flex flex-col items-center text-center">
                        <div className="w-20 h-20 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center mb-6"><CheckCircle2 size={44} /></div>
                        <h3 className="text-2xl font-black text-slate-900 mb-2">All settled!</h3>
                        <p className="text-slate-500 text-sm">Paid â‚¹{amountStr} to {settlement.to.name}.</p>
                    </div>
                )}

                {method === 'wallet' && walletStep === 'failed' && (
                    <div className="p-12 flex flex-col items-center text-center">
                        <div className="w-20 h-20 bg-rose-100 text-rose-500 rounded-full flex items-center justify-center mb-6"><AlertCircle size={44} /></div>
                        <h3 className="text-2xl font-black text-slate-900 mb-2">Payment Failed</h3>
                        <p className="text-slate-500 text-sm mb-6">Check your balance and try again.</p>
                        <button onClick={() => setWalletStep('confirm')} className="px-8 py-2.5 bg-slate-900 text-white rounded-xl font-bold text-sm">Retry</button>
                    </div>
                )}

                {/* â”€â”€ UPI: Loading â”€â”€ */}
                {method === 'upi' && upiStep === 'loading' && (
                    <div className="p-16 flex flex-col items-center text-center">
                        <Loader2 size={40} className="animate-spin text-emerald-500 mb-4" />
                        <p className="font-semibold text-slate-700">Generating UPI link...</p>
                    </div>
                )}

                {/* â”€â”€ UPI: Show QR + Apps â”€â”€ */}
                {method === 'upi' && upiStep === 'show' && upiData && (
                    <div className="p-6 overflow-y-auto max-h-[90vh]">
                        <div className="flex justify-between items-center mb-5">
                            <div>
                                <button onClick={() => { setMethod(null); setUpiStep('generate'); }} className="text-xs text-slate-400 flex items-center gap-1 hover:text-slate-600 mb-1"><ArrowRight size={12} className="rotate-180" /> Back</button>
                                <h3 className="text-xl font-bold text-slate-900">Pay via UPI</h3>
                            </div>
                            <button onClick={onClose} className="p-2 rounded-full text-slate-400 hover:bg-slate-100 transition-colors"><X size={18} /></button>
                        </div>

                        {/* QR Code */}
                        <div className="flex flex-col items-center mb-5 p-4 bg-slate-50 rounded-2xl">
                            <UPIQRCode value={upiData.upi_link} size={180} />
                            <p className="text-xs text-slate-500 mt-3 font-medium">Scan with any UPI app</p>
                        </div>

                        {/* UPI Info */}
                        <div className="bg-emerald-50 border border-emerald-100 rounded-2xl p-4 mb-4 space-y-2">
                            <div className="flex justify-between text-sm">
                                <span className="text-emerald-700 font-medium">Pay to</span>
                                <span className="font-bold text-slate-900">{upiData.to_name}</span>
                            </div>
                            <div className="flex justify-between text-sm">
                                <span className="text-emerald-700 font-medium">UPI ID</span>
                                <span className="font-mono text-sm font-bold text-slate-800">{upiData.upi_id}</span>
                            </div>
                            <div className="flex justify-between text-sm">
                                <span className="text-emerald-700 font-medium">Amount</span>
                                <span className="font-black text-slate-900 text-base">â‚¹{amountStr}</span>
                            </div>
                        </div>

                        {/* Payment App Buttons */}
                        <div className="grid grid-cols-3 gap-3 mb-4">
                            <AppButton name="Google Pay" emoji="ðŸŸ¢" color="border-green-200 bg-green-50/50" upiLink={upiData.upi_link} />
                            <AppButton name="PhonePe" emoji="ðŸŸ£" color="border-purple-200 bg-purple-50/50" upiLink={upiData.upi_link.replace('upi://', 'phonepe://')} />
                            <AppButton name="Paytm" emoji="ðŸ”µ" color="border-blue-200 bg-blue-50/50" upiLink={upiData.upi_link.replace('upi://', 'paytmmp://')} />
                        </div>

                        {/* Copy link */}
                        <button
                            onClick={handleCopy}
                            className="w-full flex items-center justify-center gap-2 py-2.5 mb-4 border border-slate-200 text-slate-600 font-semibold rounded-xl hover:bg-slate-50 transition-all text-sm"
                        >
                            {copied ? <Check size={16} className="text-emerald-500" /> : <Copy size={16} />}
                            {copied ? 'Copied!' : 'Copy UPI Link'}
                        </button>

                        {/* I have paid */}
                        <button
                            onClick={handleUPIConfirm}
                            disabled={confirming}
                            className="w-full py-3 bg-emerald-500 hover:bg-emerald-600 text-white font-bold rounded-xl shadow-lg shadow-emerald-200 transition-all active:scale-95 disabled:opacity-60"
                        >
                            {confirming ? 'Confirming...' : 'âœ… I Have Paid'}
                        </button>
                    </div>
                )}

                {/* â”€â”€ UPI: Confirmed (waiting approval) â”€â”€ */}
                {method === 'upi' && upiStep === 'confirmed' && (
                    <div className="p-12 flex flex-col items-center text-center">
                        <div className="w-20 h-20 bg-amber-100 text-amber-500 rounded-full flex items-center justify-center mb-4">
                            <Clock size={40} />
                        </div>
                        <h3 className="text-xl font-black text-slate-900 mb-2">Awaiting Approval</h3>
                        <p className="text-slate-500 text-sm mb-2">
                            Your payment confirmation has been sent to <b>{settlement.to.name}</b>.
                        </p>
                        <p className="text-xs text-slate-400 mb-6">They need to approve it to update the balances.</p>
                        <button onClick={onClose} className="px-8 py-2.5 bg-slate-900 text-white rounded-xl font-bold text-sm">Done</button>
                    </div>
                )}

            </div>
        </div>
    );
}
